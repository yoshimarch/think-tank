name: Update Links from Issues

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  issues: write

jobs:
  update-links:
    if: contains(github.event.issue.title, '[ADD LINK]')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Parse issue and update links.json
      env:
        ISSUE_TITLE: ${{ github.event.issue.title }}
        ISSUE_BODY: ${{ github.event.issue.body }}
        ISSUE_NUMBER: ${{ github.event.issue.number }}
      run: |
        node << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ Issue ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const issueTitle = process.env.ISSUE_TITLE;
        const issueBody = process.env.ISSUE_BODY;
        const issueNumber = process.env.ISSUE_NUMBER;
        
        console.log('Processing issue:', issueTitle);
        
        try {
          // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ãƒªãƒ³ã‚¯ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡º
          const titleMatch = issueTitle.match(/\[ADD LINK\]\s*(.+)/);
          if (!titleMatch) {
            throw new Error('Invalid issue title format');
          }
          const linkTitle = titleMatch[1].trim();
          
          // Issueæœ¬æ–‡ã‹ã‚‰URLã¨ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’è§£æž
          const urlMatch = issueBody.match(/URL:\s*(https?:\/\/[^\s\n]+)/i);
          const hashtagsMatch = issueBody.match(/ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°:\s*([^\n]+)/i);
          
          if (!urlMatch) {
            throw new Error('URL not found in issue body');
          }
          
          const url = urlMatch[1].trim();
          const hashtagsStr = hashtagsMatch ? hashtagsMatch[1].trim() : '';
          const hashtags = hashtagsStr ? hashtagsStr.split(/[,ã€]\s*/).map(tag => tag.trim()).filter(tag => tag) : [];
          
          // æ–°ã—ã„ãƒªãƒ³ã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
          const newLink = {
            id: Date.now().toString(),
            title: linkTitle,
            url: url,
            hashtags: hashtags,
            created_at: new Date().toISOString()
          };
          
          console.log('New link object:', JSON.stringify(newLink, null, 2));
          
          // æ—¢å­˜ã®links.jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
          const linksPath = path.join('data', 'links.json');
          let links = [];
          
          if (fs.existsSync(linksPath)) {
            const data = fs.readFileSync(linksPath, 'utf8');
            links = JSON.parse(data);
          }
          
          // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆåŒä¸€URLï¼‰
          const isDuplicate = links.some(link => link.url === newLink.url);
          if (isDuplicate) {
            console.log('Duplicate URL detected, skipping...');
            process.exit(0);
          }
          
          // æ–°ã—ã„ãƒªãƒ³ã‚¯ã‚’å…ˆé ­ã«è¿½åŠ 
          links.unshift(newLink);
          
          // ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
          fs.writeFileSync(linksPath, JSON.stringify(links, null, 2));
          
          console.log('Successfully updated links.json');
          console.log('Total links:', links.length);
          
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ï¼ˆå¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨ï¼‰
          fs.writeFileSync('update_result.txt', 'SUCCESS');
          
        } catch (error) {
          console.error('Error processing issue:', error.message);
          fs.writeFileSync('update_result.txt', 'ERROR: ' + error.message);
          process.exit(1);
        }
        EOF
    
    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/links.json
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Add new link from issue #${{ github.event.issue.number }}"
          git push
        fi
    
    - name: Comment on issue - Success
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let message = '';
          
          try {
            const result = fs.readFileSync('update_result.txt', 'utf8');
            if (result.startsWith('SUCCESS')) {
              message = `âœ… **ãƒªãƒ³ã‚¯ãŒæ­£å¸¸ã«è¿½åŠ ã•ã‚Œã¾ã—ãŸï¼**
              
              æ–°ã—ã„ãƒªãƒ³ã‚¯ã¯ [Think-Tank](https://github.com/${{ github.repository_owner }}/${{ github.event.repository.name }}) ã§ç¢ºèªã§ãã¾ã™ã€‚
              
              ðŸŽ‰ ã”æŠ•ç¨¿ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼`;
            } else {
              message = `âŒ **ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ**
              
              ${result}
              
              ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã‚’ç¢ºèªã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`;
            }
          } catch (e) {
            message = 'âŒ **å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ**';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });
    
    - name: Close issue on success
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
            const result = fs.readFileSync('update_result.txt', 'utf8');
            if (result.startsWith('SUCCESS')) {
              github.rest.issues.update({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed'
              });
            }
          } catch (e) {
            console.log('Could not close issue:', e.message);
          }
    
    - name: Add labels
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let labels = [];
          
          try {
            const result = fs.readFileSync('update_result.txt', 'utf8');
            if (result.startsWith('SUCCESS')) {
              labels = ['âœ… è¿½åŠ å®Œäº†'];
            } else {
              labels = ['âŒ ã‚¨ãƒ©ãƒ¼'];
            }
          } catch (e) {
            labels = ['âŒ ã‚¨ãƒ©ãƒ¼'];
          }
          
          if (labels.length > 0) {
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: labels
            });
          }
