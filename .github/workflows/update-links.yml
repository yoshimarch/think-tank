name: Update Links from Issues

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  issues: write

jobs:
  update-links:
    if: contains(github.event.issue.title, '[ADD LINK]')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Parse issue and update links.json
      env:
        ISSUE_TITLE: ${{ github.event.issue.title }}
        ISSUE_BODY: ${{ github.event.issue.body }}
        ISSUE_NUMBER: ${{ github.event.issue.number }}
      run: |
        node << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        try {
          const issueTitle = process.env.ISSUE_TITLE;
          const issueBody = process.env.ISSUE_BODY;
          
          const titleMatch = issueTitle.match(/\[ADD LINK\]\s*(.+)/);
          if (!titleMatch) throw new Error('Invalid title format');
          
          const linkTitle = titleMatch[1].trim();
          const urlMatch = issueBody.match(/URL:\s*(https?:\/\/[^\s\n]+)/i);
          const hashtagsMatch = issueBody.match(/ハッシュタグ:\s*([^\n]+)/i);
          
          if (!urlMatch) throw new Error('URL not found');
          
          const newLink = {
            id: Date.now().toString(),
            title: linkTitle,
            url: urlMatch[1].trim(),
            hashtags: hashtagsMatch ? hashtagsMatch[1].split(/[,、]\s*/).filter(t => t.trim()) : [],
            created_at: new Date().toISOString()
          };
          
          const linksPath = 'data/links.json';
          let links = [];
          if (fs.existsSync(linksPath)) {
            links = JSON.parse(fs.readFileSync(linksPath, 'utf8'));
          }
          
          links.unshift(newLink);
          fs.writeFileSync(linksPath, JSON.stringify(links, null, 2));
          
          console.log('Successfully updated links.json');
        } catch (error) {
          console.error('Error:', error.message);
          process.exit(1);
        }
        EOF
    
    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/links.json
        git commit -m "Add new link from issue #${{ github.event.issue.number }}" || exit 0
        git push
